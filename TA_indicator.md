Chào bạn, với tư duy của một Developer làm Finance, tôi sẽ thiết kế lại Plan Technical này theo hướng Systematic Trading (Giao dịch hệ thống). Chúng ta sẽ không "vẽ rồng vẽ phượng" mà tập trung vào Logic luồng dữ liệu (Data Flow) và Tính định lượng (Quantifiable) để bạn có thể code được ngay.Dưới đây là thiết kế kiến trúc hệ thống (Technical Architecture) ngắn gọn, hiệu quả:FLOW TỔNG QUAN (The Pipeline)Market Regime Filter (Vĩ mô): Thị trường cho phép chơi hay nghỉ?Sentiment Engine (Tâm lý): Đám đông đang sợ hay tham?Signal Scanner (Vi mô): Tìm cổ phiếu đạt chuẩn.Confluence Scoring (Định lượng): Chấm điểm độ tin cậy để ra quyết định.MODULE 1: MARKET BREADTH (Bộ Lọc Vĩ Mô)Mục tiêu: Xác định xu hướng dòng tiền toàn thị trường (Market Flow).Chỉ báo (Just Enough):% Stocks > SMA50: Đo xu hướng trung hạn.McClellan Oscillator (MCO): Đo động lượng dòng tiền vào/ra (nhạy hơn Index).Logic Flow:Bull Market (Uptrend): Khi % Stocks > SMA50 duy trì trên mức 50%.Bear Market (Downtrend): Khi % Stocks > SMA50 rớt xuống dưới 40%.Oversold (Quá bán - Cơ hội bắt đáy): Khi MCO < -70 (hoặc -50 tùy độ nhạy).Overbought (Quá mua - Rủi ro chỉnh): Khi MCO > +70.Visualization: Biểu đồ Line Chart 2 đường (% > SMA50 và MCO) chạy song song bên dưới VN-Index.MODULE 2: SENTIMENT FEAR & GREED (Hệ Thống Tâm Lý)Mục tiêu: Số hóa cảm xúc thành con số 0-100.Công thức Composite (Trọng số đề xuất):Tôi đề xuất công thức tính điểm F&G Score (0-100) dựa trên 4 thành phần:Price Strength (30%): % số mã có giá trị RSI(14) > 50.Breadth Momentum (30%): Vị thế của giá so với đường SMA20 (Tỷ lệ mã nằm trên SMA20).Volatility (20%): So sánh ATR hiện tại so với ATR trung bình 20 phiên (Biến động tăng -> Sợ hãi).Demand (20%): Tỷ lệ Volume Mua chủ động / Volume Bán chủ động toàn thị trường.Hiển thị (Gauge Chart):0 - 20 (Extreme Fear): Vùng hoảng loạn -> Cơ hội giải ngân (Contrarian Buy).20 - 40 (Fear): Thận trọng.40 - 60 (Neutral): Giằng co.60 - 80 (Greed): Hưng phấn -> Canh chốt lời dần.80 - 100 (Extreme Greed): Cảnh báo đu đỉnh.MODULE 3: SIGNAL SYSTEM (Cảnh Báo & Khuyến Nghị)Mục tiêu: Đưa ra tín hiệu Mua/Bán cụ thể cho từng mã.3.1. Các Key Indicators (Cốt lõi)Thay vì dùng quá nhiều, chỉ dùng bộ 3 chân kiềng:Trend: SMA 20 (Ngắn hạn) & SMA 50 (Trung hạn).Momentum: RSI (nhưng kết hợp phân kỳ).Volume (Quan trọng nhất): So sánh Volume phiên nay vs MA(Vol, 20).3.2. Bộ lọc Pattern (Mẫu hình nến & VSA)Dùng Python (talib hoặc custom code) để quét các mẫu hình uy tín nhất:Bullish Reversal: Hammer (Búa), Bullish Engulfing (Nhấn chìm tăng), Morning Star.VSA Signals (Dòng tiền thông minh):Stopping Volume: Giá giảm mạnh + Volume cực đại + Nến rút chân (Smart money đỡ giá).No Demand: Giá tăng/Hồi phục + Volume thấp (Cầu yếu, dễ sập tiếp).Pocket Pivot: Giá tăng thoát nền + Volume đột biến.3.3. Logic Khuyến Nghị (Recommendation Logic)BUY Signal: Giá cắt lên SMA20 + RSI > 50 + Vol > 1.2 * AvgVol.SELL Signal: Giá cắt xuống SMA20 + RSI < 50.WARNING: Giá tăng nhưng Vol giảm (Phân kỳ khối lượng) HOẶC Giá tạo đỉnh mới nhưng RSI tạo đỉnh thấp hơn (Phân kỳ âm).MODULE 4: SCORING CONFIDENCE (Độ Tin Cậy)Mục tiêu: Trả lời câu hỏi "Kèo này thơm đến mức nào?" để quyết định tỷ trọng vốn.Xây dựng hàm calculate_confidence(stock_df) trả về thang điểm 1-5 sao:Tiêu chí (Confluence)Điểm cộngLogicTrend Alignment+20đGiá nằm trên SMA50 và SMA20 đang dốc lên.Volume Confirmation+20đPhiên tăng điểm có Vol > 1.5 lần trung bình 20 phiên.Pattern+20đXuất hiện nến đảo chiều (Engulfing/Hammer) tại hỗ trợ.Market Breadth+20đVN-Index đang trong vùng Uptrend (Module 1 xanh).Indicator+20đRSI không nằm vùng quá mua (>70).Tổng100đ> 80đ: Strong Buy (Mua mạnh). 60-80: Buy (Mua thăm dò).

PLAN TRIỂN KHAI TRÊN CODE (Python/Streamlit)Bước 1: Data Processing (Pandas/Polars)Tính sẵn các cột SMA20, SMA50, RSI, Vol_MA20 cho toàn bộ dataframe lịch sử.Tính Market_Breadth bằng cách groupby('date') và đếm count(Close > SMA50).Bước 2: Dashboard Layout (Streamlit)Top (Macro): 1 Gauge Chart (Fear & Greed Index) + 1 Line Chart (Market Breadth).Middle (Scanner): Table hiển thị Top cổ phiếu có Score > 80.Columns: Mã | Giá | %Tăng | Vol/AvgVol | Tín hiệu (Buy/Sell) | Độ tin cậy (Số sao).Bottom (Detail): Khi click vào 1 mã -> Hiện Chart nến 
 
Strategy (Phân kỳ ẩn):

Nếu Giá đi ngang (Sideways) hoặc giảm nhẹ, nhưng MFI tăng dần → Gom hàng (Accumulation). Volume đang vào nhưng giá bị đè.

Nếu Giá tăng, RSI tăng, nhưng MFI giảm → Kéo xả (Distribution). Giá tăng do thiếu cung (volume thấp) chứ không phải do cầu mạnh.

Thiết Lập Quy Tắc (Rules)Chúng ta xây dựng hệ thống Regime Filter (Bộ lọc chế độ thị trường):Trạng tháiĐiều kiện (Logic kết hợp)Hành động (Action)Uptrend Mạnh$P_{MA50} > 50\%$ VÀ đường $P_{MA20}$ đang dốc lên.Aggressive: Mở Full Margin, đánh Breakout.Pullback (Chỉnh)$P_{MA50} > 50\%$ nhưng $P_{MA20}$ rớt xuống dưới 30% (Quá bán ngắn hạn).Dip Buy: Canh mua cổ phiếu mạnh khi giá đỏ.Cảnh Báo ĐỉnhVN-Index tạo đỉnh mới, nhưng $P_{MA50}$ tạo đỉnh thấp hơn (Phân kỳ).Defensive: Hạ tỷ trọng, chốt lời, không mua mới.Downtrend$P_{MA50} < 40\%$ VÀ $P_{MA20} < 20\%$.Cash is King: Cầm tiền mặt hoặc Short phái sinh.1.

4. Kết Quả Kỳ Vọng (Expected Result)Tránh được các cú sập lớn (Market Crashes) vì $P_{MA50}$ thường gãy trước khi Index sập.Nhận diện được đáy ngắn hạn khi $P_{MA20}$ chạm vùng cực thấp (dưới 10-15%).2. Technical Signal: Chiến Lược "Mean Reversion" & "Trend Following"Chúng ta sẽ chẻ nhỏ hai chiến lược kinh điển này bằng các công thức định lượng cụ thể.2.

1. Chiến Lược Bắt Đáy (Mean Reversion) với Connors RSILogic: Cổ phiếu giảm mạnh trong xu hướng tăng (Pullback) thường sẽ bật lại. Connors RSI (CRSI) tốt hơn RSI thường vì nó đo lường cả độ bền của chuỗi giảm.Công thức (Math):$$CRSI = \frac{RSI(Close, 3) + RSI(Streak, 2) + PercentRank(ROC, 100)}{3}$$(Streak: Số ngày tăng/giảm liên tiếp. ROC: Tỷ lệ thay đổi giá).Quy tắc (Set Rules):Điều kiện cần (Setup): Giá nằm TRÊN MA200 (Xu hướng dài hạn là tăng).Tín hiệu vào (Entry): $CRSI(3,2,100) < 10$ (Quá bán sâu).Tín hiệu ra (Exit): Khi giá đóng cửa TRÊN MA5 (ngắn hạn) hoặc $CRSI > 70$.System kết hợp: Kết hợp với Bollinger Bands (20, 2). Mua khi giá chạm Band dưới VÀ $CRSI < 10$.2.2. Chiến Lược Đi Theo Xu Hướng (Trend Following) với Volatility BreakoutLogic: Mua khi giá biến động mạnh vượt ra khỏi vùng tích lũy.Công thức: Sử dụng ATR (Average True Range) để đo độ nén.$$Keltner Channel Upper = EMA(20) + 2 \times ATR(10)$$Quy tắc:Setup: Độ rộng dải Bollinger (Bandwidth) co thắt lại (Squeeze) -> Báo hiệu sắp có biến động lớn.Entry: Giá đóng cửa (Close) > Keltner Channel Upper.Exit: Trailing Stop (Dời lỗ) theo đường MA20 hoặc dùng Chandelier Exit ($High_{max} - 3 \times ATR$).3. VSA & Sentiment: "Đọc Vị" Dòng Tiền (Smart Money)Phần này dùng để lọc nhiễu cho các tín hiệu kỹ thuật bên trên.3.1. Phát hiện "Stopping Volume" (Nỗ lực ngừng giảm)Logic: Giá giảm mạnh nhưng khối lượng cực lớn và nến rút chân -> Có tay to đỡ giá (Absorption).Công thức & Rules:Trend: Giá < MA20 (Đang giảm).Volume: $Vol_{today} > 2.0 \times SMA(Vol, 20)$ (Vol gấp đôi trung bình).Spread (Biên độ nến): $High - Low > 1.5 \times AvgSpread(20)$.Close Position: $(Close - Low) / (High - Low) > 0.6$ (Đóng cửa ở 40% phần trên của nến).Hành động: Đây chưa phải điểm mua ngay. Đánh dấu vào Watchlist "Chờ xác nhận đáy". Mua khi có nến xanh xác nhận sau đó.3.2. Phát hiện "No Demand" (Cạn cầu)Logic: Giá tăng (hoặc hồi) nhưng Vol thấp -> Không có dòng tiền lớn đẩy giá -> Dễ đảo chiều giảm.Công thức & Rules:Price Action: $Close > Open$ (Nến tăng) VÀ $Close > Close_{yesterday}$.Volume: $Vol_{today} < SMA(Vol, 20)$ VÀ $Vol_{today} < Vol_{yesterday}$.Spread: Nến thân nhỏ (Spread < AvgSpread).Hành động: Nếu đang cầm cổ phiếu, hãy chốt lời bớt. Tuyệt đối không mua đuổi (FOMO) ở cây nến này.4. Backtest & Risk Management: Kế Hoạch Quản Trị VốnĐây là phần biến ý tưởng thành lợi nhuận thực tế.4.1. Position Sizing (Đi tiền theo biến động)Thay vì chia đều tiền ("Mỗi mã mua 50 triệu"), ta chia đều Rủi ro.Logic: Cổ phiếu biến động mạnh (Beta cao) mua ít lại. Cổ phiếu đầm (Beta thấp) mua nhiều hơn.Công thức (Volatility Sizing):$$Q = \frac{\text{Account Risk (\$)}}{\text{Stop Loss Distance (\$)}}$$Trong đó: $\text{Stop Loss Distance} = 2 \times ATR(14)$.Ví dụ:Tài khoản 1 tỷ, chấp nhận mất 1% (10 triệu) cho 1 deal.Cổ phiếu A (ATR = 2.000đ) $\rightarrow$ Stoploss = 4.000đ $\rightarrow$ Mua $10tr / 4000 = 2.500$ cổ.Cổ phiếu B (ATR = 500đ) $\rightarrow$ Stoploss = 1.000đ $\rightarrow$ Mua $10tr / 1000 = 10.000$ cổ.4.2. Market Sentiment Filter (Bộ lọc tổng)Trước khi Backtest, hãy thêm điều kiện này vào code để lọc nhiễu:Rule: Chỉ thực hiện lệnh MUA (Long) nếu $P_{MA50} > 40\%$. (Nếu thị trường quá xấu, hệ thống tự động ngừng giao dịch - "Sit out").5. Roadmap Triển Khai (Dành cho Dev/Analyst)Bạn có thể bắt đầu code theo trình tự sau:Bước 1 (Data): Kéo data OHLCV của 457 mã. Tính sẵn các cột: MA20, MA50, MA100, RSI3, Vol_SMA20.Bước 2 (Macro): GroupBy theo ngày (Date), đếm số mã có Close > MA50. Vẽ chart này ra đè lên VN-Index để nhìn tương quan.Bước 3 (Signal): Viết hàm def get_signals(df): áp dụng công thức CRSI và VSA bên trên.Bước 4 (Scan): Chạy hàm signal cho ngày hiện tại (Today) để ra list cổ phiếu tiềm năng.Hệ thống này đủ đơn giản để chạy nhanh, nhưng đủ sâu sắc (nhờ kết hợp Market Breadth và VSA) để lọc được các "False Signals" mà các trader F0 thường mắc phải. ODULE 1: DATA PRE-PROCESSING & CLEANING (Nền Móng)Trước khi tính toán, dữ liệu phải "sạch".Adjusted Price (Giá điều chỉnh):Bắt buộc phải xử lý chia tách cổ tức. Nếu không, các tín hiệu MA, RSI sẽ bị gãy (false signal) tại ngày GDKHQ.Volume Smoothing:Volume thường biến động mạnh. Cần tạo Vol_MA20 (Volume trung bình 20 phiên) để so sánh.Logic: RVOL (Relative Volume) = Current Volume / Vol_MA20.Rule: Nếu RVOL > 1.5 -> Dòng tiền đột biến.MODULE 2: MARKET BREADTH (Độ Rộng Thị Trường)Để trả lời: "Thị trường chung đang xanh vỏ đỏ lòng hay thực sự mạnh?"Bạn yêu cầu đếm số mã trên MA20, 50, 100. Đây là logic mở rộng:2.1. Moving Average Breadth (MAB)Logic: Tính % số cổ phiếu nằm trên đường MA cho toàn thị trường và Từng Nhóm Ngành.Công thức:$$MAB_{20} = \frac{\text{Count}(Price > MA20)}{\text{Total Stocks}} \times 100\%$$Tín hiệu:MAB > 80%: Vùng quá mua (Overbought) -> Rủi ro chỉnh.MAB < 20%: Vùng quá bán (Oversold) -> Cơ hội bắt đáy.Phân kỳ: VN-Index tăng nhưng MAB giảm -> Tín hiệu suy yếu (Bull Trap).2.2. New Highs / New Lows (NH-NL)Logic: Đếm số lượng cổ phiếu lập đỉnh mới 52 tuần và đáy mới 52 tuần.Chỉ số Net High-Low: Net = New Highs - New Lows.Áp dụng: Dùng đường Cumulative Net High-Low để xác nhận xu hướng uptrend bền vững.2.3. Sector Rotation (Dòng tiền luân chuyển)Matrix: Trục X là RS (Relative Strength - ngắn hạn), Trục Y là Momentum.Hiển thị xem dòng tiền đang chảy từ Bank -> Chứng khoán -> Bất động sản như thế nào.MODULE 3: SMART MONEY & VOLUME ANALYSIS (VSA & Wyckoff)Đây là phần "Nước ngoài" hay dùng nhưng ít phổ biến ở VN. Phát hiện dấu chân dòng tiền lớn.3.1. Price Volume Trend (PVT) & OBV (On Balance Volume)Cải tiến OBV truyền thống bằng PVT để trọng số hóa mức độ tăng giá.Signal: Giá đi ngang (Sideway) nhưng OBV/PVT phá đỉnh -> Gom hàng (Accumulation).3.2. VSA Signals (Volume Spread Analysis)Phát hiện các nến bất thường:Stopping Volume: Giá giảm mạnh, Volume cực đại, nhưng nến rút chân -> Cá mập đỡ giá.No Demand: Giá tăng nhẹ, Volume rất thấp -> Cầu yếu, dễ đảo chiều giảm.Churning: Volume rất cao nhưng giá không tăng được (Spread hẹp) -> Phân phối hàng (Distribution).3.3. Liquidity Zones (Vùng thanh khoản)Xác định các vùng giá có Volume Profile lớn nhất trong quá khứ. Đó là Hỗ trợ/Kháng cự cứng.MODULE 4: COMPREHENSIVE SIGNAL SYSTEM (Bộ Tín Hiệu)Kết hợp Candlestick Patterns + Indicators.4.1. Candlestick Patterns (Tích hợp TA-Lib)Tôi đề xuất nhóm lại thành 3 nhóm quyền lực nhất:Reversal (Đảo chiều): Morning Star (Sao mai), Evening Star, Hammer (Búa), Engulfing (Nhấn chìm).Indecision (Lưỡng lự): Doji, Spinning Top (tại vùng kháng cự/hỗ trợ).Continuation (Tiếp diễn): Rising Three Methods.Code Logic (Giả lập):Python# Ví dụ logic cho Morning Star
def detect_morning_star(df):
    # Nến 1: Giảm mạnh (Body < 0, Length lớn)
    # Nến 2: Gap down, Body nhỏ (Doji/Spinning top)
    # Nến 3: Tăng mạnh, lấp > 50% thân nến 1
    return boolean
4.2. False Break & Breakout DetectionBreakout thành công: Giá vượt kháng cự (MA20 hoặc Đỉnh 20 phiên) + Volume > 1.5 lần Volume TB 20 phiên.False Break (Bull Trap): Giá vượt đỉnh trong phiên nhưng đóng cửa thấp hơn đỉnh cũ + Volume thấp hoặc Râu nến trên dài.Gãy nền (Breakdown): Giá thủng hỗ trợ + Volume lớn.4.3. Technical Confluence (Sự hội tụ)Hệ thống chấm điểm:RSI < 30 (1 điểm)Giá chạm Bollinger Band dưới (1 điểm)Có nến Hammer (1 điểm)Total: 3 điểm -> STRONG BUY.MODULE 5: SENTIMENT & FEAR/GREED INDEX (Tâm lý thị trường)Dựa trên file PPT và đặc thù VN.Xây dựng chỉ số VN-Index Fear & Greed tổng hợp từ 5 yếu tố (trọng số đề xuất):Market Momentum (25%): VN-Index hiện tại so với MA125.Stock Price Strength (25%): Số lượng mã đạt đỉnh 52 tuần vs Đáy 52 tuần.Market Breadth (15%): Khối lượng giao dịch ở chiều Tăng vs Giảm (McClellan Summation Index).Safe Haven Demand (15%): So sánh lợi suất Trái phiếu vs Cổ phiếu (E/P yield gap).Foreign & Proprietary Trading (20% - Đặc thù VN):Nếu Nước ngoài + Tự doanh Mua ròng liên tiếp 3 phiên -> Sentiment Tích cực.Bán ròng mạnh -> Tiêu cực.MODULE 6: STRATEGY & BACKTESTING (Kiểm thử chiến lược)Cho phép người dùng chọn bộ rule và xem lịch sử thắng thua.6.1. Strategy Builder (Xây dựng chiến lược)Cho phép chọn input:Entry: (MA10 cross MA20) AND (RSI < 40).Exit: (MA10 cross down MA20) OR (Trailing Stop 7%).6.2. Backtest Metrics (Chỉ số hiệu quả)Không chỉ hiển thị lãi/lỗ, cần tính:Win Rate: % thắng.Profit Factor: Tổng lãi / Tổng lỗ.Max Drawdown: Mức sụt giảm tài khoản lớn nhất (Quan trọng để quản trị rủi ro).Sharpe Ratio: Lợi nhuận trên rủi ro.KẾ HOẠCH TRIỂN KHAI CỤ THỂ (Action Plan)Phase 1: Market Breadth & Dashboard UpgradeTạo function tính % > MA20, MA50, MA100 cho toàn thị trường và group theo Industry.Vẽ biểu đồ line chart cho các chỉ số này đè lên biểu đồ VN-Index để tìm phân kỳ.Tích hợp TA-Lib để quét mô hình nến (Morning Star, Engulfing...).Phase 2: Money Flow & VSATính RVOL cho từng cổ phiếu.Tạo bộ lọc "Dòng tiền thông minh": Lọc ra các mã có Giá tăng nhẹ/đi ngang nhưng Volume gom mạnh.Xây dựng biểu đồ ngành: Ngành nào đang hút tiền mạnh nhất hôm nay?Phase 3: Fear & Greed IndexCode công thức tổng hợp 5 yếu tố tâm lý nêu trên.Hiển thị dạng Đồng hồ tốc độ (Gauge Chart) trên Dashboard.Phase 4: Backtesting EngineSử dụng thư viện backtesting.py hoặc tự viết vector backtest đơn giản bằng Pandas.Cho phép user chọn mã và chạy chiến lược MA Crossover để demo.Gợi ý Code Snippet (Python Idea)Dưới đây là ví dụ tư duy code cho phần Quét mẫu hình nến & Market Breadth:Pythonimport talib

def calculate_market_breadth(df_all_stocks):
    """
    df_all_stocks: DataFrame chứa Close price của tất cả các mã theo ngày
    """
    # Tính MA cho toàn bộ data
    df_ma20 = df_all_stocks.rolling(window=20).mean()
    
    # So sánh Price > MA
    above_ma20 = (df_all_stocks > df_ma20).sum(axis=1) # Đếm số mã > MA20 theo ngày
    total_stocks = df_all_stocks.count(axis=1)
    
    percent_above_20 = (above_ma20 / total_stocks) * 100
    return percent_above_20

def detect_candlestick_patterns(df_ohlc):
    """
    Sử dụng TA-Lib để tìm mẫu hình
    """
    patterns = {}
    
    # 1. Morning Star (Đảo chiều tăng)
    patterns['MorningStar'] = talib.CDLMORNINGSTAR(
        df_ohlc['open'], df_ohlc['high'], df_ohlc['low'], df_ohlc['close']
    )
    
    # 2. Engulfing (Nhấn chìm - trả về 100 là tăng, -100 là giảm)
    patterns['Engulfing'] = talib.CDLENGULFING(
        df_ohlc['open'], df_ohlc['high'], df_ohlc['low'], df_ohlc['close']
    )
    
    # Lọc ra các ngày có tín hiệu (khác 0)
    return patterns
