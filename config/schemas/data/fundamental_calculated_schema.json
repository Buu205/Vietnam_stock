{
  "name": "Fundamental Calculated Results Schema",
  "version": "1.0.0",
  "description": "Schema for calculated fundamental financial metrics",
  "definitions": {
    "common_calculated_fields": {
      "symbol": {
        "type": "string",
        "description": "Stock symbol",
        "pattern": "^[A-Z0-9]{2,10}$"
      },
      "report_date": {
        "type": "string",
        "format": "date",
        "description": "Financial report date"
      },
      "year": {
        "type": "integer",
        "minimum": 2000,
        "maximum": 2030,
        "description": "Report year"
      },
      "quarter": {
        "type": "integer",
        "minimum": 1,
        "maximum": 4,
        "description": "Report quarter"
      },
      "freq_code": {
        "type": "string",
        "enum": ["Q", "A", "TTM"],
        "description": "Frequency code"
      },
      "calculation_date": {
        "type": "string",
        "format": "date-time",
        "description": "Date when calculation was performed"
      },
      "data_source": {
        "type": "string",
        "description": "Source of the original data"
      },
      "calculation_version": {
        "type": "string",
        "description": "Version of calculation algorithm"
      }
    },
    "bank_calculated_metrics": {
      "profitability_ratios": {
        "roea_ttm": {
          "type": "number",
          "description": "Return on Equity TTM (%)",
          "range": [-100, 100]
        },
        "roaa_ttm": {
          "type": "number",
          "description": "Return on Average Assets TTM (%)",
          "range": [-50, 50]
        },
        "nim_q": {
          "type": "number",
          "description": "Net Interest Margin Quarterly (%)",
          "range": [0, 20]
        }
      },
      "efficiency_ratios": {
        "casa_ratio": {
          "type": "number",
          "description": "CASA Ratio (%)",
          "range": [0, 100]
        },
        "cir": {
          "type": "number",
          "description": "Cost to Income Ratio (%)",
          "range": [0, 200]
        },
        "nii_toi": {
          "type": "number",
          "description": "NII to TOI Ratio (%)",
          "range": [0, 100]
        }
      },
      "risk_ratios": {
        "npl_ratio": {
          "type": "number",
          "description": "Non-Performing Loan Ratio (%)",
          "range": [0, 50]
        },
        "ldr_pure": {
          "type": "number",
          "description": "Loan to Deposit Ratio Pure (%)",
          "range": [0, 200]
        },
        "llcr": {
          "type": "number",
          "description": "Loan Loss Coverage Ratio",
          "range": [0, 1000]
        }
      },
      "per_share_metrics": {
        "bvps": {
          "type": "number",
          "description": "Book Value Per Share (VND)",
          "minimum": 0
        },
        "eps_ttm": {
          "type": "number",
          "description": "Earnings Per Share TTM (VND)"
        }
      }
    },
    "company_calculated_metrics": {
      "profitability_ratios": {
        "gross_margin": {
          "type": "number",
          "description": "Gross Margin (%)",
          "range": [-100, 100]
        },
        "ebit_margin": {
          "type": "number",
          "description": "EBIT Margin (%)",
          "range": [-100, 100]
        },
        "ebitda_margin": {
          "type": "number",
          "description": "EBITDA Margin (%)",
          "range": [-100, 100]
        },
        "net_margin": {
          "type": "number",
          "description": "Net Margin (%)",
          "range": [-100, 100]
        },
        "roe": {
          "type": "number",
          "description": "Return on Equity (%)",
          "range": [-200, 200]
        },
        "roa": {
          "type": "number",
          "description": "Return on Assets (%)",
          "range": [-100, 100]
        }
      },
      "growth_metrics": {
        "revenue_growth_yoy": {
          "type": "number",
          "description": "Revenue Growth Year-over-Year (%)"
        },
        "profit_growth_yoy": {
          "type": "number",
          "description": "Profit Growth Year-over-Year (%)"
        },
        "eps_growth_yoy": {
          "type": "number",
          "description": "EPS Growth Year-over-Year (%)"
        }
      },
      "efficiency_metrics": {
        "asset_turnover": {
          "type": "number",
          "description": "Asset Turnover Ratio",
          "minimum": 0
        },
        "inventory_turnover": {
          "type": "number",
          "description": "Inventory Turnover Ratio",
          "minimum": 0
        },
        "receivables_turnover": {
          "type": "number",
          "description": "Receivables Turnover Ratio",
          "minimum": 0
        }
      },
      "per_share_metrics": {
        "eps": {
          "type": "number",
          "description": "Earnings Per Share (VND)"
        },
        "eps_ttm": {
          "type": "number",
          "description": "Earnings Per Share TTM (VND)"
        }
      }
    }
  },
  "schemas": {
    "bank_calculated": {
      "type": "object",
      "allOf": [
        {"$ref": "#/definitions/common_calculated_fields"},
        {
          "properties": {
            "profitability_ratios": {"$ref": "#/definitions/bank_calculated_metrics/profitability_ratios"},
            "efficiency_ratios": {"$ref": "#/definitions/bank_calculated_metrics/efficiency_ratios"},
            "risk_ratios": {"$ref": "#/definitions/bank_calculated_metrics/risk_ratios"},
            "per_share_metrics": {"$ref": "#/definitions/bank_calculated_metrics/per_share_metrics"}
          }
        }
      ],
      "required": ["symbol", "report_date", "year", "quarter", "calculation_date"]
    },
    "company_calculated": {
      "type": "object",
      "allOf": [
        {"$ref": "#/definitions/common_calculated_fields"},
        {
          "properties": {
            "profitability_ratios": {"$ref": "#/definitions/company_calculated_metrics/profitability_ratios"},
            "growth_metrics": {"$ref": "#/definitions/company_calculated_metrics/growth_metrics"},
            "efficiency_metrics": {"$ref": "#/definitions/company_calculated_metrics/efficiency_metrics"},
            "per_share_metrics": {"$ref": "#/definitions/company_calculated_metrics/per_share_metrics"}
          }
        }
      ],
      "required": ["symbol", "report_date", "year", "quarter", "calculation_date"]
    }
  },
  "validation_rules": {
    "calculation_consistency": {
      "description": "Calculated ratios should be consistent with underlying data",
      "rules": [
        "ROE should be calculated as NPATMI / Average Equity",
        "ROA should be calculated as NPATMI / Average Assets",
        "Margins should be calculated as ratios of respective profits to revenue"
      ]
    },
    "data_quality": {
      "description": "Data quality checks for calculated results",
      "rules": [
        "All ratios should be within reasonable ranges",
        "Growth rates should not exceed 1000%",
        "Negative ratios should be flagged for review"
      ]
    },
    "temporal_consistency": {
      "description": "Temporal consistency checks",
      "rules": [
        "TTM calculations should be based on last 4 quarters",
        "Year-over-year growth should be calculated correctly",
        "Quarterly data should be sequential"
      ]
    }
  }
}

