# System Architecture

**Project:** Vietnam Stock Dashboard
**Architecture Version:** 4.0.0
**Last Updated:** 2025-12-21

---

## 1. High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        USER INTERFACE                            │
│                      (Streamlit Cloud)                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │Company  │ │ Bank    │ │ Sector  │ │Valuation│ │ Forecast│   │
│  │Dashboard│ │Dashboard│ │Overview │ │Dashboard│ │Dashboard│   │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘   │
│       └───────────┴──────────┬┴──────────┴───────────┘          │
│                              ▼                                   │
│                    ┌─────────────────┐                          │
│                    │ Service Layer   │                          │
│                    │ (WEBAPP/services)│                         │
│                    └────────┬────────┘                          │
└─────────────────────────────┼───────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│                        DATA LAYER                                │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    DATA/processed/                        │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌──────────┐ │   │
│  │  │fundamental│ │ technical │ │ valuation │ │  sector  │ │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └──────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              ▲                                   │
│                              │                                   │
│                    ┌─────────┴─────────┐                        │
│                    │ PROCESSORS        │                        │
│                    │ (Daily Pipelines) │                        │
│                    └─────────┬─────────┘                        │
│                              │                                   │
│  ┌───────────────────────────┼───────────────────────────────┐  │
│  │                    DATA/raw/                               │  │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐               │  │
│  │  │   ohlcv   │ │fundamental│ │   macro   │               │  │
│  │  └───────────┘ └───────────┘ └───────────┘               │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ▲
┌─────────────────────────────┼───────────────────────────────────┐
│                     EXTERNAL SOURCES                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐      │
│  │ VNStock │    │ WiChart │    │Simplize │    │   BSC   │      │
│  │  (API)  │    │  (API)  │    │  (API)  │    │ (Excel) │      │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. Registry System

```
┌─────────────────────────────────────────────────────────────────┐
│                      REGISTRY LAYER                              │
│                     (config/ directory)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────┐    ┌───────────────────┐                 │
│  │   MetricRegistry  │    │  SectorRegistry   │                 │
│  │  (metric_lookup)  │    │ (sector_lookup)   │                 │
│  ├───────────────────┤    ├───────────────────┤                 │
│  │ • 2,099 metrics   │    │ • 457 tickers     │                 │
│  │ • VN ↔ EN mapping │    │ • 19 sectors      │                 │
│  │ • Formula registry│    │ • 4 entity types  │                 │
│  │ • Calculated defs │    │ • Peer lookup     │                 │
│  └─────────┬─────────┘    └─────────┬─────────┘                 │
│            │                        │                            │
│            └──────────┬─────────────┘                            │
│                       ▼                                          │
│            ┌───────────────────┐                                │
│            │  SchemaRegistry   │                                │
│            │ (schema_registry) │                                │
│            ├───────────────────┤                                │
│            │ • Format prices   │                                │
│            │ • Format %        │                                │
│            │ • Color schemes   │                                │
│            │ • Chart configs   │                                │
│            └───────────────────┘                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
         ┌─────────┐    ┌─────────┐    ┌─────────┐
         │ WEBAPP  │    │PROCESSORS│   │MCP_SERVER│
         │services │    │calculators│  │  tools  │
         └─────────┘    └─────────┘    └─────────┘
```

---

## 3. Data Processing Pipeline

```
┌─────────────────────────────────────────────────────────────────┐
│                    DAILY UPDATE PIPELINE                         │
│              (PROCESSORS/pipelines/run_all_daily_updates.py)     │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ 1. OHLCV      │    │ 2. Technical  │    │ 3. Macro      │
│    Update     │    │    Analysis   │    │    Commodity  │
├───────────────┤    ├───────────────┤    ├───────────────┤
│ VNStock API   │    │ TA-Lib        │    │ WiChart API   │
│      ↓        │    │      ↓        │    │ Simplize API  │
│ OHLCV_mktcap  │    │ SMA,RSI,MACD  │    │      ↓        │
│   .parquet    │    │ Bollinger,ATR │    │ macro_data    │
└───────────────┘    │      ↓        │    │   .parquet    │
                     │ basic_data    │    └───────────────┘
                     │   .parquet    │
                     └───────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              ▼
        ┌─────────────────────────────────────────┐
        │            4. Valuation                  │
        ├─────────────────────────────────────────┤
        │ ┌─────────┐ ┌─────────┐ ┌─────────┐    │
        │ │   PE    │ │   PB    │ │EV/EBITDA│    │
        │ │Calculator│ │Calculator│ │Calculator│   │
        │ └────┬────┘ └────┬────┘ └────┬────┘    │
        │      └───────────┼───────────┘          │
        │                  ▼                      │
        │         historical_*.parquet            │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │            5. Sector Analysis           │
        ├─────────────────────────────────────────┤
        │                                         │
        │  ┌────────────┐    ┌────────────┐      │
        │  │FA Aggregator│   │TA Aggregator│      │
        │  └─────┬──────┘    └─────┬──────┘      │
        │        ▼                  ▼             │
        │  ┌────────────┐    ┌────────────┐      │
        │  │ FA Scorer  │    │ TA Scorer  │      │
        │  └─────┬──────┘    └─────┬──────┘      │
        │        └──────────┬──────┘              │
        │                   ▼                     │
        │         ┌────────────────┐             │
        │         │Signal Generator│             │
        │         └───────┬────────┘             │
        │                 ▼                       │
        │    sector_combined_scores.parquet       │
        └─────────────────────────────────────────┘
```

---

## 4. Fundamental Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                  FUNDAMENTAL DATA PIPELINE                       │
└─────────────────────────────────────────────────────────────────┘

BSC CSV Files (Q3/2025)
├── COMPANY_BALANCE_SHEET.csv
├── COMPANY_INCOME.csv
├── BANK_BALANCE_SHEET.csv
├── BANK_INCOME.csv
└── ...
        │
        ▼
┌───────────────────────────────────────┐
│    csv_to_full_parquet.py             │
│    (Long format conversion)           │
├───────────────────────────────────────┤
│ ticker | period | METRIC_CODE | value │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│    run_all_calculators.py             │
│    (Calculate derived metrics)        │
├───────────────────────────────────────┤
│ ┌─────────────────────────────────┐  │
│ │ CompanyCalculator               │  │
│ │ BankCalculator                  │  │
│ │ InsuranceCalculator             │  │
│ │ SecurityCalculator              │  │
│ └─────────────────────────────────┘  │
│              │                        │
│              ▼                        │
│ ┌─────────────────────────────────┐  │
│ │     FormulaRegistry             │  │
│ │ • ROE = Net Income / Equity     │  │
│ │ • Gross Margin = GP / Revenue   │  │
│ │ • EPS = Net Income / Shares     │  │
│ │ • 40+ formulas                  │  │
│ └─────────────────────────────────┘  │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│    DATA/processed/fundamental/        │
├───────────────────────────────────────┤
│ company/company_financial_metrics.parquet │
│ bank/bank_financial_metrics.parquet       │
│ insurance/insurance_financial_metrics.parquet │
│ security/security_financial_metrics.parquet   │
└───────────────────────────────────────┘
```

---

## 5. Valuation Calculation

```
┌─────────────────────────────────────────────────────────────────┐
│                   VALUATION CALCULATION                          │
└─────────────────────────────────────────────────────────────────┘

Inputs:
├── OHLCV_mktcap.parquet (market_cap)
└── fundamental/*_financial_metrics.parquet (ttm_earnings, equity)
        │
        ▼
┌───────────────────────────────────────┐
│    VNIndexValuationCalculator         │
├───────────────────────────────────────┤
│                                       │
│ PE = Market Cap / TTM Earnings        │
│ PB = Market Cap / Total Equity        │
│ PS = Market Cap / TTM Revenue         │
│ EV/EBITDA = Enterprise Value / EBITDA │
│                                       │
│ VNINDEX PE = Sum(MCap) / Sum(Earnings)│
│ Sector PE = Sector Sum(MCap) / Sum(E) │
│                                       │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│    DATA/processed/valuation/          │
├───────────────────────────────────────┤
│ pe/historical/historical_pe.parquet   │
│ pb/historical/historical_pb.parquet   │
│ vnindex/vnindex_valuation.parquet     │
└───────────────────────────────────────┘
```

---

## 6. Sector Analysis

```
┌─────────────────────────────────────────────────────────────────┐
│                    SECTOR ANALYSIS PIPELINE                      │
│                    (SectorProcessor)                             │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: Load Registries                                          │
│ ┌───────────────────┐  ┌───────────────────┐                    │
│ │  MetricRegistry   │  │  SectorRegistry   │                    │
│ │ (2,099 metrics)   │  │ (457 tickers)     │                    │
│ └───────────────────┘  └───────────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: FA Aggregation                                           │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ FAAggregator                                                 │ │
│ │ • Load fundamental metrics by entity type                   │ │
│ │ • Map tickers to sectors                                    │ │
│ │ • Calculate sector averages: ROE, ROA, margins              │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                              ↓                                   │
│            sector_fundamental_metrics.parquet                    │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: TA Aggregation                                           │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ TAAggregator                                                 │ │
│ │ • Load valuation metrics (PE, PB)                           │ │
│ │ • Calculate sector PE/PB                                    │ │
│ │ • Momentum indicators                                       │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                              ↓                                   │
│            sector_valuation_metrics.parquet                      │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: Scoring                                                  │
│ ┌─────────────────────┐  ┌─────────────────────┐               │
│ │     FAScorer        │  │     TAScorer        │               │
│ │ • ROE score         │  │ • PE score          │               │
│ │ • Growth score      │  │ • Momentum score    │               │
│ │ • Margin score      │  │ • Technical score   │               │
│ └─────────┬───────────┘  └─────────┬───────────┘               │
│           └──────────────┬─────────┘                            │
│                          ▼                                       │
│              ┌─────────────────────┐                            │
│              │   SignalGenerator   │                            │
│              │ FA*0.5 + TA*0.5     │                            │
│              │      ↓              │                            │
│              │ BUY / SELL / HOLD   │                            │
│              └─────────────────────┘                            │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│ sector_combined_scores.parquet        │
├───────────────────────────────────────┤
│ sector | fa_score | ta_score | signal │
│ Ngân hàng | 72 | 68 | BUY            │
│ Bất động sản | 45 | 52 | HOLD       │
│ ...                                   │
└───────────────────────────────────────┘
```

---

## 7. API Client Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      API CLIENT LAYER                            │
│                    (PROCESSORS/api/)                             │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────┐
│                     BaseAPIClient                              │
│                    (Abstract Base)                             │
├───────────────────────────────────────────────────────────────┤
│ • HTTP session management                                      │
│ • Retry logic (exponential backoff)                           │
│ • Error handling                                               │
│ • Logging                                                      │
└───────────────────────────────────────────────────────────────┘
        │
        ├──────────────────┬──────────────────┬────────────────┐
        ▼                  ▼                  ▼                ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────┐
│ WiChartClient │  │SimplizeClient │  │ VNStockClient │  │FireantClient│
├───────────────┤  ├───────────────┤  ├───────────────┤  ├───────────┤
│ • FX rates    │  │ • Economic    │  │ • OHLCV       │  │ • News    │
│ • Commodities │  │   indicators  │  │ • Market cap  │  │ • Events  │
│ • Bond yields │  │ • GDP, CPI    │  │ • Fundamental │  │           │
└───────────────┘  └───────────────┘  └───────────────┘  └───────────┘
        │                  │                  │                │
        └──────────────────┴──────────────────┴────────────────┘
                                   │
                                   ▼
                    ┌───────────────────────────┐
                    │    UnifiedDataFetcher     │
                    ├───────────────────────────┤
                    │ • Standardized schema     │
                    │ • Source abstraction      │
                    │ • Fallback logic          │
                    └───────────────────────────┘
```

---

## 8. MCP Server Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      MCP SERVER                                  │
│                   (MCP_SERVER/bsc_mcp/)                         │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────┐
│                     FastMCP Server                             │
│                      (server.py)                               │
├───────────────────────────────────────────────────────────────┤
│ • stdio transport                                              │
│ • 30 registered tools                                          │
│ • Logging configuration                                        │
└───────────────────────────────────────────────────────────────┘
        │
        ├────────────────┬────────────────┬────────────────┐
        ▼                ▼                ▼                ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐
│ Ticker Tools │  │Fundamental   │  │ Technical    │  │Valuation │
│    (5)       │  │   Tools (5)  │  │  Tools (8)   │  │Tools (6) │
├──────────────┤  ├──────────────┤  ├──────────────┤  ├──────────┤
│ list_tickers │  │get_financials│  │get_indicators│  │get_pe_stats│
│ get_info     │  │compare_funds │  │get_alerts    │  │compare_val│
│ search       │  │screen_funds  │  │get_patterns  │  │sector_val │
│ get_peers    │  │              │  │market_breadth│  │           │
│ list_sectors │  │              │  │              │  │           │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────┘
        │                │                │                │
        └────────────────┴────────────────┴────────────────┘
                                   │
                                   ▼
                    ┌───────────────────────────┐
                    │    DATA/processed/*       │
                    │    (Read-only access)     │
                    └───────────────────────────┘
```

---

## 9. Component Interactions

```
┌─────────────────────────────────────────────────────────────────┐
│                    COMPONENT INTERACTION                         │
└─────────────────────────────────────────────────────────────────┘

User Request (Streamlit UI)
        │
        ▼
┌───────────────────────────────────────┐
│ WEBAPP/pages/sector/sector_dashboard.py│
│ (Dashboard Page)                       │
└───────────────────┬───────────────────┘
                    │ calls
                    ▼
┌───────────────────────────────────────┐
│ WEBAPP/services/sector_service.py     │
│ (Data Service)                        │
└───────────────────┬───────────────────┘
                    │ imports
        ┌───────────┴───────────┐
        ▼                       ▼
┌───────────────┐      ┌───────────────────┐
│config/registries│     │DATA/processed/    │
│ • SectorRegistry│     │sector/            │
│ • SchemaRegistry│     │sector_combined_   │
└───────────────┘      │scores.parquet     │
                       └───────────────────┘
```

---

## 10. Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     DEPLOYMENT ARCHITECTURE                      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      STREAMLIT CLOUD                             │
│                  (vietnamstock.streamlit.app)                    │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Streamlit Runtime                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │ main_app.py │  │  Services   │  │ Components  │     │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │   │
│  │         └─────────────────┼───────────────┘             │   │
│  │                           ▼                             │   │
│  │                ┌─────────────────┐                      │   │
│  │                │  @st.cache_data │                      │   │
│  │                │   (In-memory)   │                      │   │
│  │                └────────┬────────┘                      │   │
│  │                         ▼                               │   │
│  │                ┌─────────────────┐                      │   │
│  │                │  DATA/ (static) │                      │   │
│  │                │  (committed to  │                      │   │
│  │                │   GitHub repo)  │                      │   │
│  │                └─────────────────┘                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ git push
┌─────────────────────────────┴───────────────────────────────────┐
│                         GITHUB                                   │
│                (github.com/Buu205/Vietnam_stock)                │
├─────────────────────────────────────────────────────────────────┤
│ • Source code (WEBAPP/, PROCESSORS/, config/)                   │
│ • Data files (DATA/processed/*.parquet)                         │
│ • Documentation (docs/, README.md, CLAUDE.md)                   │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ daily update
┌─────────────────────────────┴───────────────────────────────────┐
│                    LOCAL DEVELOPMENT                             │
│                   (/Users/buuphan/Dev/)                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐                      │
│  │ Daily Pipelines │  │ Manual Updates  │                      │
│  │ (PROCESSORS/)   │  │ (BSC Excel)     │                      │
│  └────────┬────────┘  └────────┬────────┘                      │
│           └────────────────────┘                                │
│                       │                                          │
│                       ▼                                          │
│           ┌─────────────────────┐                               │
│           │ DATA/processed/     │                               │
│           │ (Updated parquet)   │                               │
│           └─────────────────────┘                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## Related Documents

- [Project Overview](project-overview-pdr.md)
- [Codebase Summary](codebase-summary.md)
- [Code Standards](code-standards.md)
